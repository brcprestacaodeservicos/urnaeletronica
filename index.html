<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Urna Eletrônica - Deploy GitHub Pages</title>

    <!-- Tailwind via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'urna-casing': '#3c4043',
                        'urna-screen': '#1f1f1f',
                        'btn-branco': '#ffffff',
                        'btn-corrige': '#ff8c00',
                        'btn-confirma': '#008000',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        .display-segment {
            width: 3rem;
            height: 4rem;
            background-color: #f0f0f0;
            border: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: bold;
            color: #1f1f1f;
            margin-right: 0.5rem;
            border-radius: 0.375rem;
        }
        .urna-key {
            transition: all 0.05s ease-out;
            font-size: 0.75rem;
        }
        @media (min-width: 768px) {
            .urna-key { font-size: 1.5rem; }
        }
        .urna-key:active { transform: scale(0.95); }
        .blink { animation: blinker 0.8s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
        .results-table th, .results-table td { padding: 8px; border: 1px solid #4B5563; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-2 md:p-4 font-sans">

    <div id="app-container" class="w-full max-w-4xl"></div>

    <!-- ======================
         Código principal (module)
         ====================== -->
    <script type="module">
    /************************************************************************
     *  URNA ELETRÔNICA - VERSÃO GITHUB PAGES (FIREBASE)
     *  IMPORTANTE: substitua os campos de firebaseConfig pelas suas chaves
     ************************************************************************/

    // ---------- CONFIGURAÇÃO (substituir pelos seus dados Firebase) ----------
    const appId = "urna2024"; // ID local para separar dados, troque se quiser
    const firebaseConfig = {
        apiKey: "SUA_API_KEY_AQUI",
        authDomain: "SEU-PROJETO.firebaseapp.com",
        projectId: "SEU_PROJETO",
        storageBucket: "SEU_PROJETO.appspot.com",
        messagingSenderId: "SEU_MESSAGING_SENDER_ID",
        appId: "SEU_APP_ID"
        // measurementId: "G-XXXX" // opcional
    };
    const initialAuthToken = null; // GitHub Pages não fornece tokens por ambiente

    // ---------- IMPORTS FIREBASE (ES Modules) ----------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, doc, getDoc, setDoc, collection, getDocs, runTransaction, setLogLevel 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ---------- VARIÁVEIS GLOBAIS ----------
    let db = null;
    let auth = null;
    let userId = null;
    window.FIREBASE_FALLBACK = false;

    // ---------- INIT FIREBASE ----------
    async function initFirebase() {
        try {
            // Se não configurou (placeholder), ativa fallback
            if (!firebaseConfig || !firebaseConfig.projectId || firebaseConfig.projectId === "SEU_PROJETO") {
                console.warn("Firebase config inválido. Entrando em modo FALLBACK offline.");
                window.FIREBASE_FALLBACK = true;
                window.runApp();
                return;
            }

            setLogLevel('debug');
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Login anônimo (para Firestore)
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("Usuário autenticado:", userId);
                    window.runApp();
                } else {
                    try {
                        await signInAnonymously(auth);
                    } catch (err) {
                        console.error("Erro ao autenticar anonimamente:", err);
                        window.FIREBASE_FALLBACK = true;
                        window.runApp();
                    }
                }
            });
        } catch (e) {
            console.error("Erro inicializando Firebase:", e);
            window.FIREBASE_FALLBACK = true;
            window.runApp();
        }
    }

    // ---------- PATHS ----------
    const ELECTION_CONFIG_PATH = `artifacts/${appId}/public/data/election_config`;
    const VOTES_COLLECTION_PATH = `artifacts/${appId}/public/data/votes`;

    // ---------- DEFAULT IMAGE ----------
    const DEFAULT_PHOTO_BASE64 = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjI0MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjNDU1QTg2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIHk9IjUyJSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IlNhbnMtU2VyaWYiIGZvbnQtc2l6ZT0iMjBweCIgZmlsbD0iI2ZmZiI+U2VtIEZvdG88L3RleHQ+PC9zdmc+';

    // ---------- Funções Firestore / Fallback ----------
    async function getOrCreateElectionConfig() {
        if (window.FIREBASE_FALLBACK) {
            return {
                roles: ['Prefeito', 'Vereador'],
                roleConfig: {
                    'Prefeito': { digits: 2, order: 1 },
                    'Vereador': { digits: 5, order: 2 }
                },
                candidates: [
                    { number: '13', name: 'João da Silva', party: 'PTZ', role: 'Prefeito', photo: DEFAULT_PHOTO_BASE64 },
                    { number: '45', name: 'Maria Souza', party: 'PSDBX', role: 'Prefeito', photo: DEFAULT_PHOTO_BASE64 },
                    { number: '55000', name: 'José Oliveira', party: 'PSDZ', role: 'Vereador', photo: DEFAULT_PHOTO_BASE64 },
                    { number: '10123', name: 'Ana Pereira', party: 'REPZ', role: 'Vereador', photo: DEFAULT_PHOTO_BASE64 },
                ]
            };
        }

        try {
            const docRef = doc(db, ELECTION_CONFIG_PATH, 'current');
            const docSnap = await getDoc(docRef);
            if (docSnap && docSnap.exists()) {
                return docSnap.data();
            } else {
                const defaultData = {
                    roles: ['Prefeito', 'Vereador'],
                    roleConfig: {
                        'Prefeito': { digits: 2, order: 1 },
                        'Vereador': { digits: 5, order: 2 }
                    },
                    candidates: []
                };
                await setDoc(docRef, defaultData);
                return defaultData;
            }
        } catch (e) {
            console.error("Erro ao acessar Firestore:", e);
            window.FIREBASE_FALLBACK = true;
            return getOrCreateElectionConfig();
        }
    }

    async function saveElectionConfig(config) {
        if (window.FIREBASE_FALLBACK) {
            console.warn("Fallback: não salva no Firestore.");
            return;
        }
        try {
            await setDoc(doc(db, ELECTION_CONFIG_PATH, 'current'), config);
            console.log("Configuração salva.");
        } catch (e) {
            console.error("Erro ao salvar configuração:", e);
            alert("Erro ao salvar configuração no Firestore.");
        }
    }

    async function registerVote(voteData) {
        if (window.FIREBASE_FALLBACK) {
            console.log("Voto (fallback):", voteData);
            // opcional: armazenar em localStorage para debug
            const arr = JSON.parse(localStorage.getItem('urna_votes') || "[]");
            arr.push({ ...voteData, timestamp: new Date().toISOString() });
            localStorage.setItem('urna_votes', JSON.stringify(arr));
            window.voto_registrado_sucesso = true;
            return;
        }

        try {
            const voteDocRef = doc(db, VOTES_COLLECTION_PATH, userId);
            await runTransaction(db, async (trx) => {
                const snap = await trx.get(voteDocRef);
                if (snap.exists()) throw new Error("Eleitor já votou.");
                trx.set(voteDocRef, { ...voteData, userId, timestamp: new Date().toISOString() });
            });
            window.voto_registrado_sucesso = true;
            console.log("Voto registrado no Firestore.");
        } catch (e) {
            console.error("Erro ao registrar voto:", e);
            window.voto_registrado_sucesso = false;
        }
    }

    // Calculate results (reads all votes)
    async function calculateResults() {
        if (window.FIREBASE_FALLBACK) {
            // contagem simples do localStorage fallback
            const arr = JSON.parse(localStorage.getItem('urna_votes') || "[]");
            const results = {};
            let total = arr.length;
            // estrutura simplificada: soma por cargo e candidato
            // para demo, retorna estrutura vazia e total
            return { results: {}, totalVotes: total, timestamp: new Date().toLocaleString('pt-BR') };
        }

        try {
            const snap = await getDocs(collection(db, VOTES_COLLECTION_PATH));
            const all = snap.docs.map(d => d.data());
            const results = {};
            const totalVotes = all.length;

            // inicializa
            (window.__electionConfig || { roles: [] }).roles?.forEach(role => {
                results[role] = { 'BRANCO': 0, 'NULO': 0 };
            });

            all.forEach(vote => {
                (window.__electionConfig || { roles: [] }).roles?.forEach(role => {
                    const val = vote[role];
                    if (!val) return;
                    if (val === 'BRANCO') results[role]['BRANCO']++;
                    else {
                        const candidateExists = (window.__electionConfig?.candidates || []).some(c => c.role === role && c.number === val);
                        if (candidateExists) {
                            results[role][val] = (results[role][val] || 0) + 1;
                        } else {
                            results[role]['NULO']++;
                        }
                    }
                });
            });

            return { results, totalVotes, timestamp: new Date().toLocaleString('pt-BR') };
        } catch (e) {
            console.error("Erro lendo votos:", e);
            return { results: {}, totalVotes: 0, timestamp: new Date().toLocaleString('pt-BR') };
        }
    }

    // ---------- UI e lógica (compilado, usando funções implementadas) ----------
    // Para manter resposta razoável, o HTML de renderização e as funções de UI
    // são versões completas e compatíveis com as funções já definidas anteriormente.
    // Aqui reutilizaremos a lógica do arquivo original: gerenciamento de estado,
    // renderAdminMode, renderVoterMode, renderResultsMode, handleKeyPress, etc.

    // Estado da aplicação
    let electionConfig = null;
    let appState = {
        mode: 'voter', // 'voter' | 'admin' | 'results'
        currentStageIndex: 0,
        currentInput: "",
        isVoteBlank: false,
        isVoteLocked: false,
        votes: {},
        adminSecretCounter: 0,
        adminSecretInput: "",
        showCandidateSuccess: false,
        resultsData: null,
        lastCandidateRegistered: null,
        confirmSecretCounter: 0,
        confirmSecretInput: ""
    };

    const appContainer = document.getElementById('app-container');

    function setState(newState) {
        Object.assign(appState, newState);
        render();
    }

    function checkAdminSecret(type, value) {
        if (appState.mode === 'results') return;

        // Admin: BRANCO x3 + 666
        if (appState.mode === 'voter' && (appState.adminSecretCounter || 0) < 3) {
            if (type === 'BRANCO') {
                appState.adminSecretCounter = (appState.adminSecretCounter || 0) + 1;
                appState.adminSecretInput = "";
            } else if (type !== 'NUMBER') {
                appState.adminSecretCounter = 0;
            }
        } else if (appState.mode === 'voter' && (appState.adminSecretCounter || 0) >= 3) {
            if (type === 'NUMBER') {
                appState.adminSecretInput = (appState.adminSecretInput || "") + value;
                if (appState.adminSecretInput.length === 3) {
                    if (appState.adminSecretInput === '666') {
                        setState({ mode: 'admin', adminSecretCounter: 0, adminSecretInput: "" });
                        return;
                    } else {
                        appState.adminSecretCounter = 0;
                        appState.adminSecretInput = "";
                        alert("ACESSO ADMINISTRADOR NEGADO.");
                        renderVoterMode();
                        return;
                    }
                }
            } else if (type !== 'BRANCO') {
                appState.adminSecretCounter = 0;
                appState.adminSecretInput = "";
            }
        }

        // Results: CONFIRMA x3 + 666
        if (appState.mode === 'voter') {
            if (type === 'CONFIRMA') {
                appState.confirmSecretCounter = (appState.confirmSecretCounter || 0) + 1;
                appState.confirmSecretInput = "";
            } else if (type === 'NUMBER') {
                if ((appState.confirmSecretCounter || 0) >= 3) {
                    appState.confirmSecretInput = (appState.confirmSecretInput || "") + value;
                    if (appState.confirmSecretInput.length === 3) {
                        if (appState.confirmSecretInput === '666') {
                            setState({ mode: 'results', confirmSecretCounter: 0, confirmSecretInput: "" });
                            return;
                        } else {
                            appState.confirmSecretCounter = 0;
                            appState.confirmSecretInput = "";
                        }
                    }
                } else {
                    appState.confirmSecretCounter = 0;
                }
            } else {
                appState.confirmSecretCounter = 0;
                appState.confirmSecretInput = "";
            }
        }
    }

    // --- UI render functions (admin, voter, results) ---
    // As funções abaixo são implementações diretas e completas do UI da urna.
    // Para enxergar todo o código da UI, incluímos abaixo as implementações.

    function renderAdminMode() {
        if (!electionConfig) return;
        if (appState.showCandidateSuccess) {
            renderCandidateSuccessScreen();
            return;
        }

        const rolesList = electionConfig.roles.map(role => {
            const config = electionConfig.roleConfig[role] || {};
            const candidateCount = electionConfig.candidates.filter(c => c.role === role).length;
            return `<li class="bg-gray-700 p-3 rounded-md flex justify-between items-center mb-2">
                <span class="font-bold">${role} (${config.digits} dígitos)</span>
                <span class="text-sm">Candidatos: ${candidateCount}</span>
                <button onclick="removeRole('${role}')" class="text-red-400 hover:text-red-500 text-sm">Remover</button>
            </li>`;
        }).join('');

        const candidateRows = electionConfig.candidates.map((c, index) => `
            <tr class="border-b border-gray-600 hover:bg-gray-600">
                <td class="p-2">${c.role}</td>
                <td class="p-2">${c.number}</td>
                <td class="p-2">${c.name}</td>
                <td class="p-2">
                    <button onclick="removeCandidate(${index})" class="text-red-400 hover:text-red-500 text-sm">Remover</button>
                </td>
            </tr>
        `).join('');

        appContainer.innerHTML = `
            <div class="bg-gray-900 text-white p-6 md:p-10 rounded-xl shadow-2xl w-full">
                <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
                    <h1 class="text-3xl font-bold text-yellow-400">PAINEL DE ADMINISTRAÇÃO</h1>
                    <button onclick="setState({ mode: 'voter' })" class="bg-red-600 hover:bg-red-700 p-2 rounded-md font-bold text-sm">Sair para Votação</button>
                </div>

                <div class="mb-8">
                    <h2 class="text-2xl font-semibold mb-4 border-l-4 border-yellow-400 pl-3">1. Configurar Cargos</h2>
                    <div class="mb-4">
                        <ul class="list-none p-0">${rolesList || '<li class="text-gray-400">Nenhum cargo cadastrado.</li>'}</ul>
                    </div>
                    <form onsubmit="addRole(event)" class="flex flex-col sm:flex-row gap-3 bg-gray-800 p-4 rounded-md">
                        <input id="new-role-name" type="text" placeholder="Nome do Cargo (Ex: Governador)" required class="flex-1 p-2 rounded text-gray-900 border border-gray-500">
                        <input id="new-role-digits" type="number" placeholder="Dígitos (2 a 5)" required min="2" max="5" class="w-20 p-2 rounded text-gray-900 border border-gray-500">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 p-2 rounded font-bold">Adicionar Cargo</button>
                    </form>
                </div>

                <div class="mb-8">
                    <h2 class="text-2xl font-semibold mb-4 border-l-4 border-yellow-400 pl-3">2. Cadastrar Candidatos</h2>
                    <form id="candidate-form" onsubmit="addCandidate(event)" class="grid grid-cols-1 md:grid-cols-5 gap-3 bg-gray-800 p-4 rounded-md">
                        <select id="cand-role" required class="p-2 rounded text-gray-900 border border-gray-500 md:col-span-1">
                            <option value="">Selecione o Cargo</option>
                            ${electionConfig.roles.map(role => `<option value="${role}">${role}</option>`).join('')}
                        </select>
                        <input id="cand-number" type="text" pattern="[0-9]*" placeholder="Número (Ex: 13)" required class="p-2 rounded text-gray-900 border border-gray-500 md:col-span-1">
                        <input id="cand-name" type="text" placeholder="Nome do Candidato" required class="p-2 rounded text-gray-900 border border-gray-500 md:col-span-1">
                        <input id="cand-party" type="text" placeholder="Partido (Ex: PT)" required class="p-2 rounded text-gray-900 border border-gray-500 md:col-span-2">

                        <div class="md:col-span-2 flex flex-col gap-2">
                            <label for="cand-photo" class="text-sm font-medium text-gray-300">Foto (máx. 50KB)</label>
                            <input id="cand-photo" type="file" accept="image/*" onchange="previewPhoto(event)" class="p-1 rounded text-gray-900 bg-white border border-gray-500">
                        </div>
                        <div class="md:col-span-1 flex justify-center items-center">
                            <img id="photo-preview" class="w-20 h-24 object-cover rounded border border-gray-600 bg-gray-700" src="https://placehold.co/80x96/4B5563/ffffff?text=Preview" alt="Prévia da Foto">
                        </div>
                        <button type="submit" class="bg-green-600 hover:bg-green-700 p-2 rounded font-bold md:col-span-2 self-end">Cadastrar Candidato</button>
                    </form>

                    <div class="mt-6 overflow-x-auto">
                        <table class="w-full text-left table-auto">
                            <thead class="text-gray-400 uppercase bg-gray-700">
                                <tr>
                                    <th class="p-2">Cargo</th>
                                    <th class="p-2">Número</th>
                                    <th class="p-2">Nome</th>
                                    <th class="p-2">Ação</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${candidateRows}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
    }

    function renderCandidateSuccessScreen() {
        const c = appState.lastCandidateRegistered || {};
        const config = electionConfig.roleConfig[c.role] || {};

        appContainer.innerHTML = `
            <div class="bg-gray-900 text-white p-6 md:p-10 rounded-xl shadow-2xl w-full">
                <h1 class="text-3xl font-bold text-green-400 mb-6 border-b border-gray-700 pb-4">Candidato Cadastrado com Sucesso!</h1>

                <div class="flex flex-col md:flex-row items-start md:items-center gap-6 bg-gray-800 p-6 rounded-lg mb-8">
                    <img class="w-24 h-32 object-cover rounded border border-gray-600 flex-shrink-0" src="${c.photo || DEFAULT_PHOTO_BASE64}" alt="Foto do Candidato">
                    <div class="flex-1">
                        <p class="text-sm text-gray-400">${c.role || '-'} (${config.digits || '-' } dígitos)</p>
                        <p class="text-2xl font-bold text-white">${c.number || '-'} - ${c.name || '-'}</p>
                        <p class="text-xl text-yellow-400">Partido: ${c.party || '---'}</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <button onclick="saveAndContinue()" class="bg-blue-600 hover:bg-blue-700 p-3 rounded-md font-bold text-lg">Salvar Configuração</button>
                    <button onclick="resetCandidateForm()" class="bg-purple-600 hover:bg-purple-700 p-3 rounded-md font-bold text-lg">Cadastrar Outro Candidato</button>
                    <button onclick="setState({ mode: 'voter', showCandidateSuccess: false })" class="bg-red-600 hover:bg-red-700 p-3 rounded-md font-bold text-lg">Sair para Votação</button>
                </div>
            </div>
        `;
    }

    function renderVoterMode() {
        if (!electionConfig || electionConfig.roles.length === 0) {
            appContainer.innerHTML = `
                <div class="bg-gray-900 text-white p-6 md:p-10 rounded-xl shadow-2xl">
                    <h1 class="text-3xl font-bold text-red-500">ERRO DE CONFIGURAÇÃO</h1>
                    <p class="mt-4">Nenhum cargo foi configurado para a eleição.</p>
                    <p class="mt-2 text-yellow-400">Acesse o modo administrador (BRANCO x3 + 666) para configurar a eleição.</p>
                    <p class="mt-4 text-sm text-gray-400">ID de Usuário: ${auth?.currentUser?.uid || 'N/A'}</p>
                </div>
            `;
            return;
        }

        if (appState.currentStageIndex >= electionConfig.roles.length) {
            renderEndScreen();
            return;
        }

        const currentRole = electionConfig.roles[appState.currentStageIndex];
        const maxDigits = electionConfig.roleConfig[currentRole]?.digits || 0;

        let numberSegmentsHTML = '';
        for (let i = 0; i < maxDigits; i++) {
            numberSegmentsHTML += `<div id="segment-${i}" class="display-segment"></div>`;
        }

        appContainer.innerHTML = `
            <div class="bg-urna-casing p-6 md:p-10 rounded-xl shadow-2xl flex flex-col md:flex-row gap-6">
                <div class="flex-1 bg-urna-screen p-4 rounded-lg shadow-inner h-[400px] md:h-[550px] flex flex-col justify-between relative">
                    <div class="text-white">
                        <div class="text-xl md:text-2xl font-bold mb-4 text-center" id="cargo-display">CARGO: ${currentRole.toUpperCase()}</div>
                        <div class="flex items-center justify-center mb-6">
                            <span class="text-sm md:text-lg mr-4">NÚMERO:</span>
                            <div id="number-input" class="flex">${numberSegmentsHTML}</div>
                        </div>
                        <div id="candidate-info" class="flex flex-col md:flex-row justify-center items-start gap-4 p-4 bg-gray-800 rounded-lg">
                            <div class="flex-shrink-0 w-36 h-44 bg-gray-500 rounded-md overflow-hidden flex items-center justify-center bg-cover bg-center" id="candidate-photo">
                                <span class="text-xs text-gray-300 p-2 text-center">Aguardando...</span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm">NOME: <span class="font-semibold" id="nome-candidato">-</span></p>
                                <p class="text-sm">PARTIDO: <span class="font-semibold" id="partido-candidato">-</span></p>
                                <p class="text-lg mt-4 text-red-400 font-bold" id="vote-status"></p>
                            </div>
                        </div>
                    </div>
                    <div id="instructions" class="text-gray-400 text-xs mt-4 border-t border-gray-700 pt-3">
                        <p>Aperte a tecla: <span class="text-btn-confirma font-bold">VERDE</span> para CONFIRMAR</p>
                        <p>Aperte a tecla: <span class="text-btn-corrige font-bold">LARANJA</span> para CORRIGIR</p>
                        <p class="mt-2 text-xs text-gray-500">ID de Usuário: ${auth?.currentUser?.uid || 'N/A'}</p>
                    </div>
                </div>
                <div class="w-full md:w-80 bg-gray-800 p-6 rounded-lg shadow-xl">
                    <div class="grid grid-cols-3 gap-3">
                        ${[1,2,3,4,5,6,7,8,9].map(n => `<button onclick="handleKeyPress('${n}')" class="urna-key bg-gray-700 text-white p-3 md:p-4 text-xl md:text-2xl font-bold rounded-md shadow-md hover:bg-gray-600">${n}</button>`).join('')}
                        <div class="col-span-1"></div>
                        <button onclick="handleKeyPress('0')" class="urna-key bg-gray-700 text-white p-3 md:p-4 text-xl md:text-2xl font-bold rounded-md shadow-md hover:bg-gray-600">0</button>
                        <div class="col-span-1"></div>
                        <button onclick="handleBlank()" class="urna-key bg-btn-branco text-gray-800 p-3 text-xs font-black rounded-md shadow-lg border border-gray-400 hover:opacity-90 mt-4">BRANCO</button>
                        <button onclick="handleCorrect()" class="urna-key bg-btn-corrige text-white p-3 text-xs font-black rounded-md shadow-lg hover:opacity-90 mt-4">CORRIGE</button>
                        <button onclick="handleConfirm()" class="urna-key bg-btn-confirma text-white p-3 text-xs font-black rounded-md shadow-lg hover:opacity-90 mt-4">CONFIRMA</button>
                    </div>
                </div>
            </div>
        `;
        updateDisplay();
    }

    function renderEndScreen() {
        const registeredSuccess = window.voto_registrado_sucesso === true;
        const message = registeredSuccess ? "SEU VOTO FOI REGISTRADO COM SUCESSO. Obrigado!" : "VOTAÇÃO ENCERRADA. (falha no registro)";
        const color = registeredSuccess ? "text-green-500" : "text-red-500";

        appContainer.innerHTML = `
            <div class="bg-gray-900 text-white p-10 rounded-xl shadow-2xl h-[400px] flex items-center justify-center">
                <div class="text-center">
                    <h1 class="text-6xl font-black ${color} animate-pulse">FIM</h1>
                    <p class="mt-6 text-lg">${message}</p>
                    <p class="mt-8 text-sm text-gray-400">Pressione CONFIRMA (3x) + 666 para o painel de resultados.</p>
                </div>
            </div>
        `;
    }

    function updateDisplay() {
        if (appState.mode !== 'voter') return;
        const currentRole = electionConfig.roles[appState.currentStageIndex];
        const maxDigits = electionConfig.roleConfig[currentRole]?.digits || 0;

        for (let i = 0; i < maxDigits; i++) {
            const segment = document.getElementById(`segment-${i}`);
            if (!segment) continue;
            segment.textContent = appState.currentInput[i] || '';
            segment.classList.remove('blink');
            if (i === appState.currentInput.length && i < maxDigits && !appState.isVoteLocked) {
                segment.classList.add('blink');
            }
        }

        const nome = document.getElementById('nome-candidato');
        const partido = document.getElementById('partido-candidato');
        const voteStatus = document.getElementById('vote-status');
        const photoDiv = document.getElementById('candidate-photo');

        if (appState.isVoteBlank) {
            nome.textContent = 'VOTO EM BRANCO';
            partido.textContent = '---';
            voteStatus.textContent = '';
            photoDiv.innerHTML = '<span class="text-lg text-white font-bold p-2 text-center">BRANCO</span>';
            photoDiv.style.backgroundImage = 'none';
        } else {
            const allFilled = appState.currentInput.length === (electionConfig.roleConfig[currentRole]?.digits || 0);
            if (allFilled) {
                const candidate = electionConfig.candidates.find(c => c.role === currentRole && c.number === appState.currentInput);
                if (candidate) {
                    nome.textContent = candidate.name;
                    partido.textContent = candidate.party;
                    voteStatus.textContent = 'VOTO VÁLIDO';
                    photoDiv.innerHTML = '';
                    photoDiv.style.backgroundImage = `url('${candidate.photo}')`;
                    photoDiv.style.backgroundSize = 'cover';
                    photoDiv.style.backgroundPosition = 'center';
                } else {
                    nome.textContent = 'VOTO INVÁLIDO OU DE LEGENDA';
                    partido.textContent = '---';
                    voteStatus.textContent = 'VOTO NULO';
                    photoDiv.innerHTML = '<span class="text-lg text-red-500 font-bold text-center">NULO</span>';
                    photoDiv.style.backgroundImage = 'none';
                }
            } else {
                nome.textContent = '-';
                partido.textContent = '-';
                voteStatus.textContent = '';
                photoDiv.innerHTML = '<span class="text-xs text-gray-300 p-2 text-center">Aguardando Número</span>';
                photoDiv.style.backgroundImage = 'none';
            }
        }
    }

    function renderResultsMode() {
        if (!appState.resultsData) {
            appContainer.innerHTML = `
                <div class="bg-gray-900 text-white p-10 rounded-xl shadow-2xl h-[400px] flex items-center justify-center">
                    <div class="text-center">
                        <h1 class="text-4xl font-bold text-yellow-400 mb-4">ENCERRANDO VOTAÇÃO...</h1>
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-yellow-400 mx-auto"></div>
                        <p class="mt-4">Processando a contagem de votos.</p>
                    </div>
                </div>
            `;
            calculateResults().then((data) => {
                setState({ resultsData: data });
            });
            return;
        }

        const { results, totalVotes, timestamp } = appState.resultsData;
        let resultsHTML = '';

        electionConfig.roles.forEach(role => {
            const roleResults = results[role] || {};
            let entries = [];
            electionConfig.candidates.filter(c => c.role === role).forEach(c => {
                entries.push({ number: c.number, name: c.name, party: c.party, votes: roleResults[c.number] || 0, isSpecial: false });
            });
            if (roleResults['BRANCO'] !== undefined) entries.push({ number: 'BRANCO', name: 'Voto em Branco', party: '---', votes: roleResults['BRANCO'], isSpecial: true });
            if (roleResults['NULO'] !== undefined) entries.push({ number: 'NULO', name: 'Voto Nulo', party: '---', votes: roleResults['NULO'], isSpecial: true });

            entries.sort((a,b) => b.votes - a.votes);

            const tableRows = entries.map(e => `
                <tr class="${e.isSpecial ? 'bg-gray-700 font-semibold' : 'hover:bg-gray-600'}">
                    <td class="p-3">${e.number}</td>
                    <td class="p-3">${e.party}</td>
                    <td class="p-3 flex-1">${e.name}</td>
                    <td class="p-3 text-right text-lg font-bold text-yellow-300">${e.votes}</td>
                </tr>
            `).join('');

            resultsHTML += `
                <h2 class="text-2xl font-bold mt-8 mb-4 border-l-4 border-green-400 pl-3">${role.toUpperCase()}</h2>
                <div class="overflow-x-auto mb-6">
                    <table class="w-full text-left results-table bg-gray-800 rounded-lg">
                        <thead>
                            <tr class="bg-gray-700 text-gray-400 uppercase text-sm">
                                <th class="p-3 w-20">Número</th>
                                <th class="p-3 w-20">Partido</th>
                                <th class="p-3 flex-1">Nome / Tipo de Voto</th>
                                <th class="p-3 w-24 text-right">Votos</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
            `;
        });

        appContainer.innerHTML = `
            <div class="bg-gray-900 text-white p-6 md:p-10 rounded-xl shadow-2xl w-full max-w-4xl">
                <div class="text-center mb-8 border-b border-gray-700 pb-4">
                    <h1 class="text-4xl font-black text-red-500">VOTAÇÃO ENCERRADA</h1>
                    <p class="text-lg text-yellow-400 mt-2">Relatório de Resultados Oficial</p>
                    <p class="text-sm text-gray-400 mt-1">Data/Hora de Encerramento: ${timestamp}</p>
                    <p class="text-md font-bold mt-4">Total de Votos (Eleitores Únicos): <span class="text-green-400">${totalVotes}</span></p>
                </div>

                ${totalVotes === 0 ? '<p class="text-center text-xl text-gray-400">Nenhum voto registrado no sistema.</p>' : resultsHTML}

                <div class="mt-8 pt-4 border-t border-gray-700 text-center">
                    <button onclick="window.location.reload()" class="bg-blue-600 hover:bg-blue-700 p-3 rounded-md font-bold text-lg">Reiniciar Simulação</button>
                </div>
            </div>
        `;
    }

    // ---------- Handlers ----------
    function handleKeyPress(key) {
        checkAdminSecret('NUMBER', key);
        if (appState.mode !== 'voter' || appState.isVoteLocked) return;
        const currentRole = electionConfig.roles[appState.currentStageIndex];
        const maxDigits = electionConfig.roleConfig[currentRole]?.digits || 0;
        if (appState.isVoteBlank) {
            setState({ currentInput: key, isVoteBlank: false, isVoteLocked: false });
        } else if (appState.currentInput.length < maxDigits) {
            setState({ currentInput: appState.currentInput + key });
        }
    }

    function handleBlank() {
        checkAdminSecret('BRANCO');
        if (appState.mode !== 'voter' || appState.isVoteLocked) return;
        setState({ currentInput: "", isVoteBlank: true, isVoteLocked: true });
    }

    function handleCorrect() {
        checkAdminSecret('CORRIGE');
        if (appState.mode !== 'voter' || appState.isVoteLocked) return;
        setState({ currentInput: "", isVoteBlank: false, isVoteLocked: false });
    }

    async function handleConfirm() {
        checkAdminSecret('CONFIRMA');
        if (appState.mode !== 'voter' || appState.isVoteLocked) return;

        const currentRole = electionConfig.roles[appState.currentStageIndex];
        const maxDigits = electionConfig.roleConfig[currentRole]?.digits || 0;
        let voteValue;
        let isValidConfirmation = false;

        if (appState.isVoteBlank) {
            voteValue = 'BRANCO';
            isValidConfirmation = true;
        } else if (appState.currentInput.length === maxDigits) {
            voteValue = appState.currentInput;
            isValidConfirmation = true;
        }

        if (isValidConfirmation) {
            appState.votes[currentRole] = voteValue;
            document.body.classList.add('bg-btn-confirma');
            setTimeout(() => document.body.classList.remove('bg-btn-confirma'), 100);

            const nextStageIndex = appState.currentStageIndex + 1;
            if (nextStageIndex < electionConfig.roles.length) {
                setState({ currentStageIndex: nextStageIndex, currentInput: "", isVoteBlank: false, isVoteLocked: false });
            } else {
                await registerVote(appState.votes);
                setState({ currentStageIndex: nextStageIndex });
            }
        } else {
            console.log("Confirmação inválida.");
        }
    }

    // Keyboard listeners
    document.addEventListener('keydown', (e) => {
        if (appState.mode === 'admin') return;
        const key = e.key;
        if (/\d/.test(key)) handleKeyPress(key);
        else if (key === 'Enter') { e.preventDefault(); handleConfirm(); }
        else if (key === 'Backspace' || key === 'Delete') { e.preventDefault(); handleCorrect(); }
        else if (key.toUpperCase() === 'B') handleBlank();
    });

    // ---------- Admin helpers (add/remove candidate/role, preview photo) ----------
    function getBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = err => reject(err);
        });
    }

    function previewPhoto(event) {
        const file = event.target.files[0];
        const preview = document.getElementById('photo-preview');
        if (!file) { preview.src = "https://placehold.co/80x96/4B5563/ffffff?text=Preview"; return; }
        const MAX = 50 * 1024;
        if (file.size > MAX) { preview.src = "https://placehold.co/80x96/B91C1C/ffffff?text=MUITO+GRANDE"; return; }
        const reader = new FileReader();
        reader.onload = (e) => preview.src = e.target.result;
        reader.readAsDataURL(file);
    }

    function addRole(event) {
        event.preventDefault();
        const name = document.getElementById('new-role-name').value.trim();
        const digits = parseInt(document.getElementById('new-role-digits').value, 10);
        if (name && digits >= 2 && digits <= 5 && !electionConfig.roles.includes(name)) {
            electionConfig.roles.push(name);
            const order = electionConfig.roles.length;
            electionConfig.roleConfig[name] = { digits, order };
            saveElectionConfig(electionConfig);
            renderAdminMode();
        } else alert("Verifique os dados do cargo.");
    }

    function removeRole(roleName) {
        if (!confirm(`Remover cargo ${roleName}?`)) return;
        electionConfig.roles = electionConfig.roles.filter(r => r !== roleName);
        delete electionConfig.roleConfig[roleName];
        electionConfig.candidates = electionConfig.candidates.filter(c => c.role !== roleName);
        saveElectionConfig(electionConfig);
        renderAdminMode();
    }

    async function addCandidate(event) {
        event.preventDefault();
        const form = event.target;
        const role = form.querySelector('#cand-role').value;
        const number = form.querySelector('#cand-number').value.trim();
        const name = form.querySelector('#cand-name').value.trim();
        const party = form.querySelector('#cand-party').value.trim();
        const file = form.querySelector('#cand-photo').files[0];
        const roleConfig = electionConfig.roleConfig[role];
        if (!role || !number || !name || !party || !roleConfig) { alert("Preencha tudo."); return; }
        if (number.length !== roleConfig.digits || !/^\d+$/.test(number)) { alert(`Número deve ter ${roleConfig.digits} dígitos.`); return; }
        if (electionConfig.candidates.some(c => c.number === number && c.role === role)) { alert("Número já cadastrado."); return; }
        let photo = DEFAULT_PHOTO_BASE64;
        if (file) {
            if (file.size > 50*1024) { alert("Foto > 50KB"); return; }
            try { photo = await getBase64(file); } catch(e){ alert("Erro ao ler foto."); return; }
        }
        const newC = { role, number, name, party, photo };
        electionConfig.candidates.push(newC);
        setState({ showCandidateSuccess: true, lastCandidateRegistered: newC });
        form.reset();
        document.getElementById('photo-preview').src = "https://placehold.co/80x96/4B5563/ffffff?text=Preview";
    }

    function removeCandidate(index) {
        if (!confirm("Remover candidato?")) return;
        electionConfig.candidates.splice(index, 1);
        saveElectionConfig(electionConfig);
        renderAdminMode();
    }

    function saveAndContinue() {
        saveElectionConfig(electionConfig);
        setState({ showCandidateSuccess: false });
    }
    function resetCandidateForm() { setState({ showCandidateSuccess: false }); }

    // ---------- Exports para uso global (botões inline chamam essas funções) ----------
    window.addRole = addRole;
    window.removeRole = removeRole;
    window.addCandidate = addCandidate;
    window.removeCandidate = removeCandidate;
    window.handleKeyPress = handleKeyPress;
    window.handleBlank = handleBlank;
    window.handleCorrect = handleCorrect;
    window.handleConfirm = handleConfirm;
    window.previewPhoto = previewPhoto;
    window.saveAndContinue = saveAndContinue;
    window.resetCandidateForm = resetCandidateForm;
    window.registerVote = registerVote;
    window.getOrCreateElectionConfig = getOrCreateElectionConfig;
    window.calculateResults = calculateResults;
    window.DEFAULT_PHOTO_BASE64 = DEFAULT_PHOTO_BASE64;

    // ---------- runApp (inicial) ----------
    window.runApp = async function() {
        electionConfig = await getOrCreateElectionConfig();
        // Guarda global para calculateResults acessar
        window.__electionConfig = electionConfig;
        // Ordena cargos por order
        electionConfig.roles.sort((a,b) => (electionConfig.roleConfig[a]?.order||0) - (electionConfig.roleConfig[b]?.order||0));
        render();
    }

    function render() {
        if (appState.mode === 'admin') renderAdminMode();
        else if (appState.mode === 'results') renderResultsMode();
        else renderVoterMode();
    }

    // Inicia Firebase (ou fallback) agora
    initFirebase();

    </script>
</body>
</html>

