
<!doctype html>
<html lang="pt-BR">
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Admin - Urna</title>
<link rel="stylesheet" href="assets/css/theme.css">
</head>
<body>
<div class="container">
  <div class="topbar">
    <h1>Admin • Painel</h1>
    <div>
      <button onclick="location.href='index.html'" class="btn">Voltar Urna</button>
      <button id="export-btn" class="btn" style="background:#2563eb;color:white">Export Backup</button>
      <button id="import-btn" class="btn" style="background:#059669;color:white">Import Backup</button>
      <button id="end-btn" class="btn" style="background:#dc2626;color:white">Encerrar Votação (gera relatório)</button>
    </div>
  </div>

  <h2>Configuração</h2>
  <div id="roles-list"></div>

  <h3>Cadastrar Candidato</h3>
  <form id="cand-form">
    <select id="cand-role"></select>
    <input id="cand-number" placeholder="Número">
    <input id="cand-name" placeholder="Nome">
    <input id="cand-party" placeholder="Partido">
    <button type="submit" class="btn" style="background:#10b981;color:white">Adicionar</button>
  </form>

  <h3>Candidatos</h3>
  <div id="candidates-table"></div>

  <h3>Votos (raw)</h3>
  <pre id="votes-raw" style="background:#0f172a;color:#e2e8f0;padding:8px;border-radius:6px"></pre>

</div>

<script>
let DB = JSON.parse(localStorage.getItem('urna_db') || '{}');
if(!DB || !DB.roles) { fetch('data/backup.json').then(r=>r.json()).then(d=>{DB=d;localStorage.setItem('urna_db',JSON.stringify(DB)); init();}).catch(e=>{DB={roles:[],roleConfig:{},candidates:[],votes:[]};init();}); } else { init(); }

function init(){
  renderRoles();
  renderCandidates();
  renderVotes();
  document.getElementById('cand-form').addEventListener('submit', addCandidate);
  document.getElementById('export-btn').addEventListener('click', exportBackup);
  document.getElementById('import-btn').addEventListener('click', importBackup);
  document.getElementById('end-btn').addEventListener('click', ()=>{ localStorage.setItem('urna_ended','1'); location.href='results.html?auto=true'; });
}

function renderRoles(){
  const roles = DB.roles || [];
  const el = document.getElementById('roles-list');
  el.innerHTML = '<strong>Cargos:</strong> ' + roles.map(r=>`${r} (${DB.roleConfig[r].digits} díg)`).join(' | ');
  const sel = document.getElementById('cand-role');
  sel.innerHTML = '<option value="">Selecione</option>' + roles.map(r=>`<option value="${r}">${r}</option>`).join('');
}

function renderCandidates(){
  const t = document.getElementById('candidates-table');
  t.innerHTML = '<table class="table"><tr><th>Cargo</th><th>Número</th><th>Nome</th><th>Partido</th><th>Ações</th></tr>' +
    (DB.candidates||[]).map((c,i)=>`<tr><td>${c.role}</td><td>${c.number}</td><td>${c.name}</td><td>${c.party}</td><td><button onclick="removeCand(${i})" class="btn" style="background:#b91c1c;color:white">Remover</button></td></tr>`).join('') +
    '</table>';
}

function renderVotes(){ document.getElementById('votes-raw').textContent = JSON.stringify(DB.votes,null,2); }

function addCandidate(e){
  e.preventDefault();
  const role = document.getElementById('cand-role').value;
  const number = document.getElementById('cand-number').value.trim();
  const name = document.getElementById('cand-name').value.trim();
  const party = document.getElementById('cand-party').value.trim();
  if(!role||!number||!name){ alert('Preencha'); return; }
  DB.candidates.push({role,number,name,party,photo:''});
  localStorage.setItem('urna_db',JSON.stringify(DB));
  renderCandidates();
}

function removeCand(i){ if(!confirm('Remover?')) return; DB.candidates.splice(i,1); localStorage.setItem('urna_db',JSON.stringify(DB)); renderCandidates(); }

function exportBackup(){
  const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(DB,null,2));
  const a = document.createElement('a'); a.href = dataStr; a.download = 'urna-backup.json'; a.click();
}

function importBackup(){
  const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange = e=>{ const file=e.target.files[0]; const reader=new FileReader(); reader.onload=ev=>{ try{ const d=JSON.parse(ev.target.result); DB=d; localStorage.setItem('urna_db',JSON.stringify(DB)); alert('Importado'); location.reload(); }catch(err){alert('Arquivo inválido');} }; reader.readAsText(file); };
  inp.click();
}
</script>
</body>
</html>
